<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Annotator demo</title>
    <style>
      body {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
        letter-spacing: 0.01rem;
        font-size: 22px;
        line-height: 1.5;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
      }
      header, article {
        width: 740px;
        margin: 2em auto;
      }
      .highlight {
        background: rgba(255, 10, 10, 0.3);
      }
      .topbar {
          overflow: hidden;
          background-color: #999;
          position: fixed; /* Set the navbar to fixed position */
          top: 0; /* Position the navbar at the top of the page */
          width: 100%; /* Full width */
          height: 180px;
      }
      .bodydiv {
margin: 180px auto 0;
      width: 100%;
            
      }
    </style>
  </head>

  <body>
<div class='topbar'>
        <div class"loadmenu">
            <input type="file" multiple><br>
            <select></select><br>
            <textarea id="myTextarea" style="display:none;"></textarea>
        </div>
        <div class="highlightmenu">

<button onclick="addHighlight(getSelectionText())">Add Highlight</button>
<button onclick="undoHighlight(getSelectionText())">Undo Highlight</button>
        </div>
        <div class="savefile">
        <button onclick="saveTextAsFile()">Save Annotated Text to File</button>
        </div>
</div>
<div class='bodydiv'>
    <header>
      <h1 id="titleName">Title</h1>
    </header>
    <article id="mainText">
        default text
    </article>
</div>
<!-- The main load script -->
<script>
  const [input, select, textarea, reader] = [
    document.querySelector("input[type=file]")
    , document.querySelector("select")
    , document.querySelector("textarea")
    , new FileReader
  ];
  let [files, data, fn] = [
    [],
    [], (file, reader) => new Promise((resolve, reject) => {
      reader.onload = () => {
        reader.onload = reader.onerror = null;
        resolve(reader.result);
      }
      reader.onerror = reject;
      reader.readAsText(file);
    })
  ];
  input.onchange = async() => {
    select.innerHTML = "";
    files.length = data.length = 0;
    for (const file of input.files) {
      const {
        name
      } = file;
      const option = new Option(name, files.length);
      files.push(file);
      select.appendChild(option);
      let result = await fn(file, reader);
      data.push(result);
    }
    textarea.value = data[select.value];
    updateInnerHTML();
  }

function updateInnerHTML() {
    var x = document.getElementById("myTextarea").value;
    document.getElementById("mainText").innerHTML = x;
    document.getElementById("titleName").innerHTML = select.options[select.value].text;
}

  select.onchange = () => {
    textarea.value = data[select.value];
    updateInnerHTML();
  }
</script>


    <!-- The main Annotator script 
    <script src="annotator.min.js"></script>
    <script>
      if (typeof annotator === 'undefined') {
        alert("Oops! it looks like you haven't built Annotator. " +
              "Either download a tagged release from GitHub, or build the " +
              "package by running `make`");
      } else {
        var app = new annotator.App();
        app.include(annotator.ui.main);
        app.start().then(function () {
     app.annotations.load();
});
      }
    </script>
-->

<script>

var nHighlights=0;
function getSelectionText(){
    var selectedText = ""
    if (window.getSelection){ // all modern browsers and IE9+
        selectedText = window.getSelection().toString()
    }
    console.log(selectedText)
    return selectedText
}

function addHighlight(text)
{
    inputText = document.getElementById("mainText");
    var innerHTML = inputText.innerHTML;
    var index = innerHTML.indexOf(text);
    if ( index >= 0 )
    { 
        innerHTML = innerHTML.substring(0,index) + "<span id='highlight"+nHighlights+"' class='highlight'>" + innerHTML.substring(index,index+text.length) + "</span>" + innerHTML.substring(index + text.length);
        inputText.innerHTML = innerHTML; 
        nHighlights++;
    }

}
function undoHighlight(text)
{
    highlightID = "highlight"+nHighlights;
    console.log(highlightID);
    myHighlight = document.getElementById("highlight"+(nHighlights-1));
    console.log(myHighlight);
    parent = myHighlight.parentNode;
    parent.insertBefore(  myHighlight.firstChild, myHighlight );
     parent.removeChild(myHighlight);
    nHighlights--;
}
</script>

<style>
.highlight
{
background-color:yellow;
}
</style>
 
<script type="text/javascript">
 
function saveTextAsFile()
{
    var textToSave = document.getElementById("mainText").innerHTML;
    var textToSaveAsBlob = new Blob([textToSave], {type:"text/html"});
    var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
    var fileNameToSaveAs = select.options[select.value].text;
    //document.getElementById("inputFileNameToSaveAs").value;
 
    var downloadLink = document.createElement("a");
    downloadLink.download = fileNameToSaveAs.concat('_output');
    downloadLink.innerHTML = "Download File";
    downloadLink.href = textToSaveAsURL;
    downloadLink.onclick = destroyClickedElement;
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);
 
    downloadLink.click();
}
 
function destroyClickedElement(event)
{
    document.body.removeChild(event.target);
}
 
</script>

  </body>
</html>
